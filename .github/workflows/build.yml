name: Arduino CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Update Arduino CLI
      run: |
        arduino-cli core update-index

    - name: Install Arduino Mega core
      run: |
        arduino-cli core install arduino:megaavr
        arduino-cli core install arduino:avr

    - name: Install required libraries
      run: |
        # Install PID_v1 library
        arduino-cli lib install "PID"

    - name: Install YFROBOT Motor Driver Library
      run: |
        # Create Arduino user libraries directory if it doesn't exist
        mkdir -p ~/Arduino/libraries

        # Download and install YFROBOT Motor Driver Library manually
        cd ~/Arduino/libraries
        wget -q -O yfrobot-lib.zip https://github.com/YFROBOT-TM/Yfrobot-Motor-Driver-Library/archive/master.zip
        unzip -q yfrobot-lib.zip

        # Create the library directory and copy files from src/
        mkdir -p Yfrobot_Motor_Driver_Library
        cp -r Yfrobot-Motor-Driver-Library-master/src/* Yfrobot_Motor_Driver_Library/
        cp Yfrobot-Motor-Driver-Library-master/*.txt Yfrobot_Motor_Driver_Library/ 2>/dev/null || true
        cp Yfrobot-Motor-Driver-Library-master/*.md Yfrobot_Motor_Driver_Library/ 2>/dev/null || true
        cp Yfrobot-Motor-Driver-Library-master/*.properties Yfrobot_Motor_Driver_Library/ 2>/dev/null || true
        cp Yfrobot-Motor-Driver-Library-master/*.json Yfrobot_Motor_Driver_Library/ 2>/dev/null || true

        # Clean up
        rm -rf Yfrobot-Motor-Driver-Library-master yfrobot-lib.zip

    - name: Compile Omni Motor Control sketch
      run: |
        cd omni_motor_control
        arduino-cli compile --fqbn arduino:avr:mega omni_motor_control.ino

    - name: Compile I2C Scanner sketch
      run: |
        cd i2c_scanner
        arduino-cli compile --fqbn arduino:avr:mega i2c_scanner.ino

    - name: Verify compilation success
      run: |
        echo "âœ… All Arduino sketches compiled successfully!"
        echo "ðŸ“‹ Build Summary:"
        echo "  - Omni Motor Control: âœ… Compiled"
        echo "  - I2C Scanner: âœ… Compiled"
        echo "  - Target Board: Arduino Mega (ATmega2560)"
